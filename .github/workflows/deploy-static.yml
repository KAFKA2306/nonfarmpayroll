name: Deploy Static Dashboard

on:
  # æ‰‹å‹•ãƒˆãƒªã‚¬ãƒ¼ï¼šUI ã ã‘æ›´æ–°ã—ãŸã„å ´åˆã«å®Ÿè¡Œ
  workflow_dispatch:
    inputs:
      use_demo_data:
        description: "æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãŒç„¡ã„å ´åˆã«ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã™ã‚‹"
        required: false
        default: "false"     # æœ¬ç•ªã®å®‰å…¨ç­–ã¨ã—ã¦æ—¢å®šã¯ false
        type: boolean

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-static
  cancel-in-progress: false   # é€”ä¸­ã‚¸ãƒ§ãƒ–ã®å¼·åˆ¶ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã‚’é˜²ã

jobs:
  prepare-site:
    runs-on: ubuntu-latest

    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªå–å¾—
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. Pythonï¼ˆãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ç”¨ï¼‰ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"

      - name: Install minimal dependencies
        run: |
          pip install pandas numpy

      # 3. ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã¨ãƒ‡ãƒ¼ã‚¿ã‚’ docs/ ã«é…ç½®
      - name: Build static dashboard
        env:
          USE_DEMO: ${{ inputs.use_demo_data }}
        run: |
          set -e

          # --- UI ãƒ•ã‚¡ã‚¤ãƒ« ---
          mkdir -p docs
          cp dashboard.html docs/index.html
          cp dashboard.css dashboard.js docs/

          # --- ãƒ‡ãƒ¼ã‚¿æº–å‚™ ---
          if [ -f data_processed/nfp_revisions.csv ]; then
            echo "â–¶ï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨"
          elif [ "$USE_DEMO" == "true" ]; then
            echo "âš ï¸ æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ãªã—ã€‚ãƒ‡ãƒ¢ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™"
            python - <<'PY'
import pandas as pd, numpy as np, json, datetime as dt, pathlib
pathlib.Path("data_processed").mkdir(exist_ok=True)

dates = pd.date_range("2000-01-01", dt.date.today(), freq="MS")
rng   = np.random.default_rng(42)
level = np.linspace(130_000, 165_000, len(dates))
season= 1_800 * np.sin(2*np.pi*np.arange(len(dates))/12)
noise = rng.normal(0, 450, len(dates))
final = level + season + noise

rev   = rng.normal(20, 65, len(dates))
df = pd.DataFrame({
    "date": dates,
    "final": final.astype(int),
    "release1": (final-rev).astype(int),
    "release2": (final-rev*0.4).astype(int),
    "release3": (final-rev*0.1).astype(int),
    "rev_final": rev.astype(int),
    "se": 85,
})
df.to_csv("data_processed/nfp_revisions.csv", index=False)

summary = {"generated": dt.datetime.utcnow().isoformat(),
           "records": len(df)}
with open("data_processed/summary_report.json","w") as f:
    json.dump(summary, f, indent=2)
PY
          else
            echo "::error::data_processed/nfp_revisions.csv ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚use_demo_data=true ã§å†å®Ÿè¡Œã—ã¦ãã ã•ã„"
            exit 1
          fi

          cp -r data_processed docs/

          # --- ãƒ¡ã‚¿æƒ…å ±ãƒ•ã‚¡ã‚¤ãƒ« ---
          date -u +"%Y-%m-%d %H:%M:%S UTC" > docs/last_updated.txt

          cat > docs/status.json <<EOF
          {
            "status": "operational",
            "deployment_type": "static",
            "data_mode": "$([[ "$USE_DEMO" == "true" ]] && echo demo || echo existing)",
            "last_updated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "workflow_run": "${{ github.run_id }}",
            "commit_sha": "${{ github.sha }}"
          }
EOF

          # --- ãƒ‡ãƒ¢ãƒãƒŠãƒ¼æŒ¿å…¥ ---
          if [ "$USE_DEMO" == "true" ]; then
            sed -i 's/<body>/<body><div style="background:#f59e0b;color:#fff;text-align:center;padding:10px;position:fixed;top:0;width:100%;z-index:9999;">âš ï¸ DEMO&nbsp;MODE â€” Simulated&nbsp;data</div><div style="height:50px;"></div>/' docs/index.html
          fi

      # 4. docs/index.html ãŒç„¡ã„å ´åˆã¯å¤±æ•—
      - name: Sanity check
        run: test -f docs/index.html

      # 5. Pages ç”¨ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä½œæˆ
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/

  deploy:
    needs: prepare-site
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy-step.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deploy-step
        uses: actions/deploy-pages@v4

      - name: Deployment summary
        run: |
          echo "## ğŸ“Š Static Dashboard Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**URL:** https://kafka2306.github.io/nonfarmpayroll/" >> $GITHUB_STEP_SUMMARY
          echo "**Data Mode:** $([[ '${{ inputs.use_demo_data }}' == 'true' ]] && echo Demo || echo Existing)" >> $GITHUB_STEP_SUMMARY
          echo "**Completed:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
